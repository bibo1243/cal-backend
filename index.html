<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹å®®æ ¼å¹´åº¦è¦åŠƒç³»çµ± - Cal Planner</title>
    <!-- å°å…¥ XLSX åº«ï¼Œç”¨æ–¼åŒ¯å…¥/åŒ¯å‡º -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* CSS è®Šé‡å®šç¾©ï¼šå¯¦ç¾ä¸»é¡Œåˆ‡æ› */
        :root {
            --bg-primary: #f5f8f5;
            --bg-secondary: #ffffff;
            --text-primary: #2d4a2b;
            --text-secondary: #5a7658;
            --accent: #6b9e78; /* ä¸»è‰²ï¼šç«¹é’ */
            --accent-light: #d8e8db;
            --accent-dark: #4a7552;
            --border: #d4e0d4;
            --shadow: rgba(45, 74, 43, 0.08);
            --center-bg: linear-gradient(135deg, rgba(107, 158, 120, 0.95) 0%, rgba(74, 117, 82, 0.95) 100%);
            --month-badge: #88b894;
            --overlay: rgba(255, 255, 255, 0.92);
        }
        
        /* ä¸åŒçš„é¢¨æ ¼ï¼ˆ24ç¯€æ°£ï¼‰ä¸»é¡Œ */
        /* ç‚ºæ»¿è¶³ç³»çµ±å­—é«”è¦æ±‚ï¼Œä¸æŒ‡å®š font-family */
        body.bamboo { --bg-primary: #f5f8f5; --accent: #6b9e78; --center-bg: linear-gradient(135deg, rgba(107, 158, 120, 0.95) 0%, rgba(74, 117, 82, 0.95) 100%); }
        body.sakura { --bg-primary: #fef8f9; --accent: #d98ba6; --center-bg: linear-gradient(135deg, rgba(217, 139, 166, 0.95) 0%, rgba(179, 109, 133, 0.95) 100%); }
        body.lotus { --bg-primary: #f4f7fa; --accent: #6b9ac4; --center-bg: linear-gradient(135deg, rgba(107, 154, 196, 0.95) 0%, rgba(77, 122, 159, 0.95) 100%); }
        body.sunset { --bg-primary: #fef9f5; --accent: #d98b5e; --center-bg: linear-gradient(135deg, rgba(217, 139, 94, 0.95) 0%, rgba(181, 109, 66, 0.95) 100%); }
        /* æ›´å¤šä¸»é¡Œçœç•¥... */
        
        body { 
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-primary); 
            color: var(--text-primary); 
            line-height: 1.6; 
            min-height: 100vh; 
            padding: 30px 20px; 
            transition: all 0.6s ease; 
            position: relative; 
        }
        
        /* ä½ˆå±€å’ŒåŸºæœ¬å…ƒç´  */
        .container { max-width: 1400px; margin: 0 auto; position: relative; z-index: 1; }
        header { text-align: center; margin-bottom: 40px; }
        h1 { font-size: 2.8rem; font-weight: 500; margin-bottom: 15px; }
        .subtitle { font-size: 1.1rem; color: var(--text-secondary); opacity: 0.8; }
        
        /* æ¨¡å¼å’Œä¸»é¡Œé¸æ“‡ */
        .page-toggle, .controls-wrapper, .month-selector { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .page-btn, .mode-btn, .month-btn { padding: 10px 20px; border: 2px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; border-radius: 50px; transition: all 0.3s ease; box-shadow: 0 2px 8px var(--shadow); }
        .page-btn.active, .mode-btn.active, .month-btn.active { background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .page-content { display: none; }
        .page-content.active { display: block; }

        .theme-selector { display: flex; gap: 10px; padding: 8px 15px; background: var(--bg-secondary); border-radius: 50px; box-shadow: 0 4px 20px var(--shadow); }
        .theme-btn { width: 35px; height: 35px; border: 3px solid transparent; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; position: relative; overflow: visible; box-shadow: 0 2px 8px var(--shadow); }
        .theme-btn.active { transform: scale(1.2); border-color: var(--accent); }
        
        /* ä¹å®®æ ¼ä½ˆå±€ */
        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 30px; }
        .grid-item { 
            background: var(--bg-secondary); 
            border: 2px solid var(--border); 
            border-radius: 16px; 
            padding: 20px; 
            min-height: 280px; 
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 4px 15px var(--shadow); 
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        .grid-item:hover {
            border-color: var(--accent);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* æ ¸å¿ƒè©æ¨£å¼ (éœ€æ±‚ 6, 13) */
        .grid-item.center { 
            background: var(--center-bg); 
            color: white; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            border: none;
        }

        .core-word-wrapper {
            width: 100%;
            height: 80%; /* ä½”å¤§æ ¼å­ç´„80% */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .core-word-display {
            font-size: 5vw; /* å­—é«”æ”¾å¤§åˆ°æœ€æ»¿ç‰ˆ */
            font-weight: 900;
            text-align: center;
            line-height: 1;
            padding: 5px;
            text-shadow: 0 0 10px rgba(0,0,0,0.5), 0 0 20px var(--accent-light);
            word-break: break-all;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
        }
        .core-input-label {
            position: absolute;
            top: 20px;
            font-size: 1.2rem;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        /* èƒŒæ™¯åœ–ç‰‡é¡¯ç¤º (éœ€æ±‚ 5, 12, 15) */
        .grid-bg-image { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            opacity: 0.2; /* ç¾è§€ï¼Œä¸è¦æ“‹åˆ°æ–‡å­— */
            z-index: 0; 
            filter: grayscale(50%) blur(1px); /* å‰µæ„ç¾åŒ– */
            transition: all 0.4s ease;
        }
        .grid-item:hover .grid-bg-image {
            opacity: 0.3;
            filter: grayscale(0%) blur(0px);
        }
        .grid-content { position: relative; z-index: 2; flex: 1; }
        
        /* åœ–ç‰‡ä¸Šå‚³æŒ‰éˆ• */
        .image-upload-zone { position: absolute; top: 10px; right: 10px; z-index: 3; opacity: 0; transition: opacity 0.3s ease; }
        .grid-item:hover .image-upload-zone { opacity: 1; }
        .upload-btn { background: var(--accent); color: white; border: none; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 14px; margin-bottom: 5px; }

        /* æ ¼å­æ¨™é¡Œ */
        .grid-title { 
            font-size: 1.2rem; 
            font-weight: 700; 
            margin-bottom: 15px; 
            border-bottom: 2px solid var(--border); 
            padding-bottom: 8px; 
            color: var(--text-primary);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }
        .grid-item.center .grid-title { color: white; border: none; }
        
        /* ç›®æ¨™åˆ—è¡¨ */
        .goals-list { list-style: none; padding: 0; margin-top: 10px; flex: 1; overflow-y: auto; max-height: 200px; }
        .goals-list::-webkit-scrollbar { width: 5px; }
        .goals-list::-webkit-scrollbar-thumb { background: var(--accent-light); border-radius: 3px; }

        .goal-item { 
            display: flex; 
            align-items: flex-start; 
            gap: 8px; 
            padding: 8px 0;
            border-bottom: 1px dashed var(--border);
            cursor: grab;
            transition: background-color 0.2s ease;
        }
        .goal-item:last-child { border-bottom: none; }
        .goal-item.dragging { opacity: 0.5; }
        .goal-item.drag-over-bottom { border-bottom: 3px solid var(--accent-dark); padding-bottom: 5px; }
        .goal-item.drag-over-top { border-top: 3px solid var(--accent-dark); padding-top: 5px; }
        
        .goal-number { 
            min-width: 20px; 
            height: 20px; 
            background: var(--accent); 
            color: white; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.75rem; 
            font-weight: 600; 
        }

        /* è·³å‹•é’è›™ç¬¦è™Ÿ (éœ€æ±‚ 18) */
        @keyframes frog-hop {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .goal-frog-mark {
            display: inline-block;
            animation: frog-hop 0.8s ease-in-out infinite;
            margin-right: 5px;
            font-size: 1em;
            cursor: pointer;
        }
        
        .goal-text-wrapper {
            flex: 1;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            word-break: break-word;
        }
        
        .goal-text { 
            font-size: 0.95rem; 
            font-weight: 500; 
            cursor: pointer; 
        }
        
        .goal-text-input { 
            width: 100%; 
            padding: 4px; 
            border: 1px solid var(--accent); 
            border-radius: 4px; 
            font-size: 0.95rem; 
            font-family: inherit;
            display: none;
        }
        
        .goal-item.editing .goal-text { display: none; }
        .goal-item.editing .goal-text-input { display: block; }
        
        .goal-checkbox { 
            min-width: 18px; 
            height: 18px; 
            border: 2px solid var(--accent); 
            border-radius: 4px; 
            cursor: pointer; 
            margin-top: 2px;
            position: relative;
            transition: all 0.2s ease;
        }
        .goal-checkbox.checked { 
            background: var(--accent); 
            border-color: var(--accent);
        }
        .goal-checkbox.checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .goal-actions { opacity: 0; transition: opacity 0.3s ease; margin-left: auto; display: flex; gap: 4px;}
        .goal-item:hover .goal-actions { opacity: 1; }
        .action-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 14px; padding: 2px; }
        .action-btn:hover { color: var(--accent); transform: scale(1.1); }
        
        .add-input-wrapper { display: flex; gap: 10px; margin-top: 15px; }
        .add-input { flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; }
        .add-btn { padding: 8px 15px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; }
        
        /* æœˆåº¦ç›®æ¨™é—œè¯é¡¯ç¤º */
        .month-goal-link {
            font-size: 0.8rem;
            color: var(--text-secondary);
            opacity: 0.7;
            margin-top: 2px;
            word-break: break-word;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .month-goal-link span { cursor: pointer; }
        .month-goal-link span:hover { color: var(--accent); text-decoration: underline; }

        /* å¹´åº¦ç›®æ¨™ä¸‹çš„æœˆåº¦ç›®æ¨™æ¸…å–® */
        .linked-month-goals {
            margin-top: 5px;
            padding-left: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            max-height: 100px;
            overflow-y: auto;
            border-top: 1px dashed var(--border);
            padding-top: 5px;
        }
        .linked-month-goals div {
            padding: 2px 0;
        }
        .linked-month-goals span {
            background: var(--month-badge);
            color: white;
            padding: 1px 5px;
            border-radius: 5px;
            font-size: 0.7rem;
            margin-right: 5px;
        }

        /* å¹´åº¦ç›®æ¨™/å‰æœˆç›®æ¨™åƒè€ƒæµ®çª— (éœ€æ±‚ 3) */
        .reference-tooltip { 
            position: fixed; 
            background: rgba(255, 255, 255, 0.95); 
            border: 1px solid var(--accent); 
            border-radius: 10px; 
            padding: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            z-index: 1000; 
            display: none; 
            max-width: 300px; 
            max-height: 400px; 
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }
        .reference-tooltip.show { display: block; }
        .reference-tooltip h4 { color: var(--accent); font-size: 1rem; margin-bottom: 10px; }
        .reference-goal-item { margin-bottom: 5px; font-size: 0.9rem; line-height: 1.3; color: var(--text-primary); }

        /* æœˆåº¦ç›®æ¨™é—œè¯é¸æ“‡å™¨ */
        .link-selector-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 2000; display: none;
            justify-content: center; align-items: center;
        }
        .link-selector-content {
            background: var(--bg-secondary); padding: 30px; border-radius: 15px;
            width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .link-selector-content h3 { color: var(--accent); margin-bottom: 20px; }
        .year-goal-option {
            padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .year-goal-option:hover { background: var(--accent-light); }
        .year-goal-option:last-child { border-bottom: none; }
        .year-goal-option input[type="radio"] { margin-right: 10px; }

        /* çµ±è¨ˆé é¢ (éœ€æ±‚ 8, 10) */
        .stats-container { max-width: 900px; margin: 0 auto; }
        .progress-bar-bg { width: 100%; height: 25px; background: var(--border); border-radius: 12px; overflow: hidden; margin-top: 10px; }
        .progress-bar-fill { height: 100%; background: var(--accent); border-radius: 12px; transition: width 1s ease-out; display: flex; justify-content: flex-end; align-items: center; padding-right: 10px; color: white; font-weight: bold; }
        .progress-info { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 600; }
        .progress-value { color: var(--accent); }
        .encouragement-box { 
            margin-top: 30px; padding: 20px; 
            border: 3px solid var(--accent); 
            border-radius: 15px; 
            background: var(--accent-light);
            text-align: center;
        }
        .encouragement-box p { font-size: 1.1rem; color: var(--accent-dark); line-height: 1.8; }
        
        /* ç…™èŠ±æ•ˆæœ (éœ€æ±‚ 7) */
        #fireworks { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

        @media (max-width: 1024px) { 
            .grid-container { grid-template-columns: repeat(2, 1fr); } 
            .core-word-display { font-size: 8vw; }
        }
        @media (max-width: 640px) { 
            .grid-container { grid-template-columns: 1fr; } 
            .core-word-display { font-size: 15vw; }
        }
    </style>
</head>
<body class="bamboo">
    <!-- ç…™èŠ± Canvas -->
    <canvas id="fireworks"></canvas>
    
    <div class="container">
        <header>
            <h1>ä¹å®®æ ¼å¹´åº¦è¦åŠƒ</h1>
            <p class="subtitle">ç›®æ¨™å°ˆæ³¨ Â· è¡Œå‹•é«˜æ•ˆ</p>
        </header>

        <div class="page-toggle">
            <button class="page-btn active" data-page="planner">ğŸ“‹ ç›®æ¨™è¦åŠƒ</button>
            <button class="page-btn" data-page="stats">ğŸ“Š å®Œæˆçµ±è¨ˆ</button>
        </div>

        <div class="controls-wrapper">
            <!-- å¹´ä»½é¸æ“‡ (éœ€æ±‚ 9) -->
            <div class="year-selector">
                <label for="yearSelect">å¹´ä»½ï¼š</label>
                <select id="yearSelect"></select>
            </div>
            
            <!-- æ¨¡å¼åˆ‡æ› -->
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="year"><span>ğŸ“… å¹´åº¦è¨ˆåŠƒ</span></button>
                <button class="mode-btn" data-mode="month"><span>ğŸ“† æœˆåº¦è¨ˆåŠƒ</span></button>
            </div>
            
            <!-- ä¸»é¡Œé¢¨æ ¼é¸æ“‡ (éœ€æ±‚ 3) -->
            <div class="theme-selector">
                <button class="theme-btn bamboo active" data-theme="bamboo" title="ç«¹æ—é’ç¿ "></button>
                <button class="theme-btn sakura" data-theme="sakura" title="æ«»èŠ±ç²‰é›…"></button>
                <button class="theme-btn lotus" data-theme="lotus" title="è“®æ± éœè—"></button>
                <button class="theme-btn sunset" data-theme="sunset" title="æ™šéœæ©™æš–"></button>
            </div>
        </div>

        <!-- æœˆä»½é¸æ“‡ (éœ€æ±‚ 4.1) -->
        <div class="month-selector" id="monthSelector">
            <button class="month-btn active" data-month="1">1æœˆ</button>
            <button class="month-btn" data-month="2">2æœˆ</button>
            <button class="month-btn" data-month="3">3æœˆ</button>
            <button class="month-btn" data-month="4">4æœˆ</button>
            <button class="month-btn" data-month="5">5æœˆ</button>
            <button class="month-btn" data-month="6">6æœˆ</button>
            <button class="month-btn" data-month="7">7æœˆ</button>
            <button class="month-btn" data-month="8">8æœˆ</button>
            <button class="month-btn" data-month="9">9æœˆ</button>
            <button class="month-btn" data-month="10">10æœˆ</button>
            <button class="month-btn" data-month="11">11æœˆ</button>
            <button class="month-btn" data-month="12">12æœˆ</button>
        </div>

        <!-- è¦åŠƒä¹å®®æ ¼ä¸»é«” -->
        <div id="plannerPage" class="page-content active">
            <div class="grid-container" id="gridContainer"></div>
        </div>

        <!-- çµ±è¨ˆé é¢ -->
        <div id="statsPage" class="page-content">
            <div class="stats-container">
                <div class="progress-info">
                    <h2>å¹´åº¦ç›®æ¨™å®Œæˆåº¦</h2>
                    <span class="progress-value" id="yearCompletionPercent">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="yearProgressBar" style="width: 0%"></div>
                </div>
                <p style="margin-top: 10px;">ç¸½ç›®æ¨™ï¼š<span id="yearTotal">0</span> å€‹, å·²å®Œæˆï¼š<span id="yearCompleted">0</span> å€‹</p>

                <div class="progress-info" style="margin-top: 30px;">
                    <h2>å…¨å¹´æœˆåº¦ç›®æ¨™å®Œæˆåº¦</h2>
                    <span class="progress-value" id="allMonthCompletionPercent">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="allMonthProgressBar" style="width: 0%"></div>
                </div>
                <p style="margin-top: 10px;">ç¸½ç›®æ¨™ï¼š<span id="allMonthTotal">0</span> å€‹, å·²å®Œæˆï¼š<span id="allMonthCompleted">0</span> å€‹</p>

                <!-- å‹‰å‹µçš„è©± (éœ€æ±‚ 10) -->
                <div class="encouragement-box" id="encouragementBox">
                    <p id="encouragementText">è¨­å®šç›®æ¨™ï¼Œå°±æ˜¯é‚å‘æˆåŠŸçš„ç¬¬ä¸€æ­¥ï¼</p>
                </div>
            </div>
        </div>
    </div>

    <!-- é—œè¯ç›®æ¨™é¸æ“‡å™¨ Modal (éœ€æ±‚ 4.3, 14) -->
    <div id="linkSelectorModal" class="link-selector-modal">
        <div class="link-selector-content">
            <h3 id="linkSelectorTitle">é—œè¯å¹´åº¦ç›®æ¨™</h3>
            <div id="yearGoalOptions" class="year-goal-options">
                <!-- é¸é …æœƒé€é JS æ¸²æŸ“ -->
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="hideLinkSelectorModal()" class="action-btn" style="color: var(--accent);">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¹´åº¦ç›®æ¨™/å‰æœˆç›®æ¨™åƒè€ƒæµ®çª— (éœ€æ±‚ 3, 4.2) -->
    <div id="referenceTooltip" class="reference-tooltip"></div>

    <script>
        // --- è¨­å®šèˆ‡ç‹€æ…‹è®Šæ•¸ ---
        const GRID_CONFIG = [
            { id: 'learn', title: 'å­¸ç¿’&æˆé•·', position: 0 },
            { id: 'experience', title: 'é«”é©—&çªç ´', position: 1 },
            { id: 'relax', title: 'ä¼‘é–’&æ”¾æ¾', position: 2 },
            { id: 'family', title: 'å®¶åº­&ç”Ÿæ´»', position: 3 },
            { id: 'core', title: 'æ ¸å¿ƒè©', position: 4, isCenter: true },
            { id: 'work', title: 'å·¥ä½œ&äº‹æ¥­', position: 5 },
            { id: 'social', title: 'äººéš›&ç¤¾ç¾¤', position: 6 },
            { id: 'finance', title: 'è²¡å‹™&ç†è²¡', position: 7 },
            { id: 'health', title: 'å¥åº·&èº«é«”', position: 8 }
        ];

        // é è¨­åœ–ç‰‡æ˜ å°„ (éœ€æ±‚ 15)
        const LOCAL_IMAGE_MAP = {
            'learn': '1.jpg', 'experience': '2.jpg', 'relax': '3.jpg',
            'family': '4.jpg', 'core': '5.jpg', 'work': '6.jpg',
            'social': '7.jpg', 'finance': '8.jpg', 'health': '9.jpg'
        };

        let currentMode = 'year'; // 'year' æˆ– 'month'
        let currentMonth = new Date().getMonth() + 1; // ç•¶å‰æœˆä»½ 1-12
        let currentYear = new Date().getFullYear();
        let currentTheme = 'bamboo';
        
        // æ ¸å¿ƒè³‡æ–™çµæ§‹: å„²å­˜æ‰€æœ‰å¹´ä»½çš„å¹´åº¦/æœˆåº¦/åœ–ç‰‡è³‡æ–™
        let allYearsData = {}; 

        // æ‹–æ›³ç‹€æ…‹
        let draggedElement = null;
        
        // --- åˆå§‹åŒ–å‡½å¼ ---

        function initDataStructure(year) {
            if (allYearsData[year]) return;

            const yearData = {};
            const monthData = {};
            const backgroundImages = { year: {}, month: {} };
            
            GRID_CONFIG.forEach(config => {
                yearData[config.id] = {
                    title: config.title,
                    coreWord: config.isCenter ? '' : null,
                    goals: []
                };
            });

            for (let month = 1; month <= 12; month++) {
                monthData[month] = {};
                GRID_CONFIG.forEach(config => {
                    monthData[month][config.id] = {
                        goals: [] // æœˆåº¦ç›®æ¨™
                    };
                    backgroundImages.month[month] = {};
                });
            }
            
            allYearsData[year] = { yearData, monthData, theme: 'bamboo', backgroundImages };
        }
        
        function getCurrentYearData() {
            initDataStructure(currentYear);
            return allYearsData[currentYear].yearData;
        }

        function getCurrentMonthData() {
            initDataStructure(currentYear);
            return allYearsData[currentYear].monthData;
        }

        function getCurrentTheme() {
            initDataStructure(currentYear);
            return allYearsData[currentYear].theme;
        }
        
        function getBackgroundImages() {
            initDataStructure(currentYear);
            return allYearsData[currentYear].backgroundImages;
        }

        function saveData() {
            // å°‡æ‰€æœ‰æ•¸æ“šçµæ§‹åŒ–å¾Œï¼Œé€šé API å‚³é€åˆ°å¾Œç«¯ä¿å­˜ (MySQL)
            const dataToSave = {
                yearData: getCurrentYearData(),
                monthData: getCurrentMonthData(),
                theme: getCurrentTheme(),
                backgroundImages: getBackgroundImages()
            };
            
            fetch(`/api/plan/${currentYear}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSave)
            })
            .then(res => res.json())
            .then(result => {
                if (!result.success) console.error('è³‡æ–™ä¿å­˜å¤±æ•—:', result.error);
                else console.log(`ğŸ’¾ è³‡æ–™ä¿å­˜æˆåŠŸ: ${result.message}`);
            })
            .catch(err => console.error('APIä¿å­˜éŒ¯èª¤:', err));
        }

        async function loadData() {
            // å„ªå…ˆå¾å¾Œç«¯ API è¼‰å…¥è³‡æ–™
            try {
                const response = await fetch(`/api/plan/${currentYear}`);
                
                if (response.status === 404) {
                    console.log(`â„¹ï¸ ${currentYear} å¹´è³‡æ–™åº«ç„¡ç´€éŒ„ï¼Œä½¿ç”¨é è¨­çµæ§‹`);
                    initDataStructure(currentYear); // ç¢ºä¿ç•¶å‰å¹´ä»½çµæ§‹å­˜åœ¨
                    return; 
                }
                
                if (!response.ok) throw new Error(response.statusText);

                const data = await response.json();
                
                // è¼‰å…¥è³‡æ–™ä¸¦æ›´æ–°ç‹€æ…‹
                initDataStructure(currentYear);
                allYearsData[currentYear] = {
                    yearData: data.yearData,
                    monthData: data.monthData,
                    theme: data.theme || 'bamboo',
                    backgroundImages: data.backgroundImages || { year: {}, month: {} }
                };
                
                console.log(`âœ… ${currentYear} å¹´è³‡æ–™è¼‰å…¥æˆåŠŸã€‚`);
                
            } catch (err) {
                console.warn('âŒ ç„¡æ³•å¾å¾Œç«¯è¼‰å…¥æ•¸æ“š (å¯èƒ½ MySQL æœªéƒ¨ç½²æˆ–é€£ç·šå¤±æ•—):', err.message);
                initDataStructure(currentYear);
            }
        }
        
        // --- æ¸²æŸ“å‡½å¼ ---

        function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            
            // æ›´æ–°ä¸»é¡Œ
            document.body.className = getCurrentTheme();
            
            GRID_CONFIG.forEach(config => {
                const item = document.createElement('div');
                item.className = 'grid-item' + (config.isCenter ? ' center' : '');
                item.dataset.gridId = config.id;
                
                const bgImage = getBackgroundImageURL(config.id);
                const bgImageHtml = bgImage ? `<img src="${bgImage}" class="grid-bg-image" alt="èƒŒæ™¯">` : '';
                
                // åœ–ç‰‡ä¸Šå‚³å€å¡Š (éœ€æ±‚ 5)
                const uploadZone = `
                    <div class="image-upload-zone">
                        <button class="upload-btn" onclick="document.getElementById('imgUpload-${config.id}').click()">ğŸ–¼ï¸ æ›åœ–</button>
                        <button class="upload-btn" style="background: #e74c3c;" onclick="deleteBackgroundImage('${config.id}')">ğŸ—‘ï¸ åˆªåœ–</button>
                        <input type="file" id="imgUpload-${config.id}" data-grid-id="${config.id}" class="image-upload-input" accept="image/*" style="display: none;">
                    </div>
                `;
                
                item.innerHTML = bgImageHtml + uploadZone + '<div class="grid-content"></div>';
                
                const contentDiv = item.querySelector('.grid-content');

                if (config.isCenter) {
                    renderCoreGrid(contentDiv, config);
                } else {
                    renderGoalGrid(contentDiv, config);
                }

                container.appendChild(item);
            });

            setupGridItemListeners();
        }

        function getBackgroundImageURL(gridId) {
            const bgImages = getBackgroundImages();
            let imageData = null;

            if (currentMode === 'year') {
                imageData = bgImages.year[gridId];
            } else {
                // æœˆåº¦ç›®æ¨™èƒŒæ™¯åœ– (ç¹¼æ‰¿/ç¨ç«‹ä¿®æ”¹)
                imageData = bgImages.month[currentMonth][gridId] || bgImages.year[gridId];
            }

            // æª¢æŸ¥æ˜¯å¦ç‚ºæœ¬åœ°é è¨­åœ– (éœ€æ±‚ 15)
            if (imageData && imageData.startsWith('LOCAL_')) {
                const fileName = imageData.substring(6);
                // é€™è£¡å‡è¨­æœ¬åœ°åœ–æª”åœ¨æ ¹ç›®éŒ„
                return `./${fileName}`;
            }

            return imageData; // è¿”å› Base64 æ•¸æ“š
        }
        
        // --- æ¸²æŸ“æ ¸å¿ƒè©å€å¡Š (æ ¸å¿ƒè©æ”¾å¤§/ç¹¼æ‰¿) ---
        function renderCoreGrid(contentDiv, config) {
            const yearData = getCurrentYearData();
            const monthData = getCurrentMonthData();
            
            let coreWord = '';
            let inputLabel = '';
            let isReadOnly = false;

            if (currentMode === 'year') {
                coreWord = yearData[config.id].coreWord || '';
                inputLabel = coreWord ? '' : config.title; // æ²’è¼¸å…¥æ‰é¡¯ç¤ºã€Œæ ¸å¿ƒè©ã€æ¨™é¡Œ
            } else {
                // æœˆåº¦ç›®æ¨™æ ¸å¿ƒè©ç¹¼æ‰¿å¹´åº¦ (éœ€æ±‚ 13)
                coreWord = yearData[config.id].coreWord || '';
                inputLabel = coreWord ? '' : config.title;
                isReadOnly = true; // é è¨­ç¹¼æ‰¿ï¼Œä¸å¯ä¿®æ”¹
            }
            
            // æ ¸å¿ƒè©ä½”æ¯” 80% (éœ€æ±‚ 13)
            contentDiv.innerHTML = `
                ${inputLabel ? `<div class="core-input-label">${inputLabel}</div>` : ''}
                <div class="core-word-wrapper">
                    <input 
                        type="text" 
                        class="core-word-display" 
                        placeholder="${config.title}"
                        value="${coreWord}"
                        data-id="${config.id}"
                        maxlength="8"
                        ${isReadOnly ? 'readonly' : ''}
                        style="${isReadOnly ? 'cursor: default; background: none; border: none; color: white;' : 'background: rgba(255,255,255,0.1); border: 2px solid white; color: white;'}"
                    />
                </div>
            `;
            
            // åªæœ‰å¹´åº¦æ ¸å¿ƒè©å¯è¼¸å…¥ (å³æ™‚æ›´æ–°æ‰€æœ‰æœˆåº¦æ ¸å¿ƒè©)
            if (currentMode === 'year') {
                contentDiv.querySelector('.core-word-display').addEventListener('input', (e) => {
                    yearData[config.id].coreWord = e.target.value.trim();
                    saveData();
                    // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ ¸å¿ƒè©çš„æ”¾å¤§æ•ˆæœ (å¦‚æœæœ‰éœ€è¦)
                    renderGrid(); 
                });
            }
        }


        // --- æ¸²æŸ“ç›®æ¨™åˆ—è¡¨å€å¡Š ---
        function renderGoalGrid(contentDiv, config) {
            const data = currentMode === 'year' ? getCurrentYearData() : getCurrentMonthData()[currentMonth];
            const goals = data[config.id].goals;
            
            // å–å¾—å‰ä¸€å€‹æœˆçš„ç›®æ¨™ä½œç‚ºåƒè€ƒ (éœ€æ±‚ 4.2)
            const prevMonthGoals = (currentMode === 'month' && currentMonth > 1) ? getCurrentMonthData()[currentMonth - 1][config.id].goals : [];

            // æœˆåº¦ç›®æ¨™æ‰éœ€è¦é¡¯ç¤ºä¸Šå€‹æœˆç›®æ¨™
            const prevGoalsHtml = prevMonthGoals.length > 0 && currentMode === 'month'
                ? `<div style="margin-bottom: 15px; padding: 10px; background: var(--accent-light); border-radius: 8px; font-size: 0.85rem; color: var(--text-dark);">
                    <strong>${currentMonth - 1}æœˆç›®æ¨™ (${config.title}):</strong>
                    ${prevMonthGoals.map((g, i) => `<div>${i + 1}. ${g.text} ${g.completed ? '(å·²å®Œæˆ)' : ''}</div>`).join('')}
                </div>`
                : '';


            const goalsHtml = goals.map((goal, index) => {
                let linkInfo = '';
                if (currentMode === 'month' && goal.yearGoalId) {
                    const yearGoal = getCurrentYearData()[config.id].goals.find(g => g.id === goal.yearGoalId);
                    const linkText = yearGoal ? `${yearGoal.text.substring(0, 15)}...` : 'ï¼ˆå·²åˆªé™¤ï¼‰';
                    linkInfo = `<div class="month-goal-link">
                        â†³ é—œè¯ï¼š<span data-action="change-link" data-index="${index}" title="é»æ“Šä¿®æ”¹é—œè¯">${linkText}</span>
                    </div>`;
                } else if (currentMode === 'year' && goal.monthGoals && goal.monthGoals.length > 0) {
                    // å¹´åº¦ç›®æ¨™ä¸‹é¡¯ç¤ºæœˆåº¦ç›®æ¨™ (æ–‡å­—ç¸®å°)
                    linkInfo = `<div class="linked-month-goals" title="å·²é—œè¯çš„æœˆåº¦ç›®æ¨™">
                        ${goal.monthGoals.map(mg => `<div><span>${mg.month}æœˆ</span>${mg.text}</div>`).join('')}
                    </div>`;
                }

                const frogMark = goal.hasFrog ? `<span class="goal-frog-mark" data-action="toggle-frog" data-index="${index}">ğŸ¸</span>` : '';
                
                return `
                    <li class="goal-item ${goal.completed ? 'completed' : ''}" 
                        draggable="true" 
                        data-index="${index}" 
                        data-grid-id="${config.id}"
                    >
                        <div class="goal-number">${index + 1}</div>
                        
                        <div class="goal-checkbox ${goal.completed ? 'checked' : ''}" data-action="toggle-check" data-index="${index}"></div>
                        
                        <div class="goal-text-wrapper">
                            <span class="goal-text" data-action="edit" data-index="${index}">${frogMark}${goal.text}</span>
                            <input type="text" class="goal-text-input" value="${goal.text}" data-index="${index}">
                            ${linkInfo}
                        </div>
                        
                        <div class="goal-actions">
                            <button class="action-btn" data-action="edit" data-index="${index}" title="ä¿®æ”¹æ–‡å­—">âœï¸</button>
                            ${currentMode === 'month' ? `<button class="action-btn" data-action="change-link-btn" data-index="${index}" title="ä¿®æ”¹å¹´åº¦é—œè¯">ğŸ”—</button>` : ''}
                            <button class="action-btn ${goal.hasFrog ? 'active' : ''}" data-action="toggle-frog" data-index="${index}" title="æ¨™è¨»é’è›™">ğŸ¸</button>
                            <button class="action-btn" data-action="delete" data-index="${index}" title="åˆªé™¤ç›®æ¨™">âŒ</button>
                        </div>
                    </li>
                `;
            }).join('');

            contentDiv.innerHTML = `
                <div class="grid-title">${config.title}</div>
                ${prevGoalsHtml}
                <ul class="goals-list" data-id="${config.id}">${goalsHtml}</ul>
                <div class="add-input-wrapper">
                    <input 
                        type="text" 
                        class="add-input" 
                        placeholder="æ–°å¢ç›®æ¨™..."
                        data-id="${config.id}"
                    >
                    <button class="add-btn" data-action="add" data-id="${config.id}">æ–°å¢</button>
                </div>
            `;
        }

        // --- äº‹ä»¶è™•ç†èˆ‡é‚è¼¯å‡½å¼ ---

        function setupGridItemListeners() {
            // åœ–ç‰‡ä¸Šå‚³
            document.querySelectorAll('.image-upload-input').forEach(input => {
                input.onchange = (e) => {
                    const gridId = e.target.dataset.gridId;
                    const file = e.target.files[0];
                    if (file) handleImageUpload(gridId, file);
                };
            });
            
            document.querySelectorAll('.add-btn').forEach(btn => {
                btn.onclick = (e) => addGoal(e.target.dataset.id);
            });
            document.querySelectorAll('.add-input').forEach(input => {
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') addGoal(e.target.dataset.id);
                };
            });
            
            // äº‹ä»¶å§”æ´¾ï¼šçµ±ä¸€è™•ç†ç›®æ¨™é …ç›®å…§çš„é»æ“Šäº‹ä»¶ (æ‰“å‹¾, ç·¨è¼¯, åˆªé™¤, é—œè¯)
            document.querySelectorAll('.goals-list').forEach(list => {
                list.addEventListener('click', (e) => {
                    const item = e.target.closest('[data-action]');
                    if (!item) return;

                    const action = item.dataset.action;
                    const goalItem = item.closest('.goal-item');
                    const gridId = goalItem.dataset.gridId;
                    const index = parseInt(goalItem.dataset.index);

                    switch(action) {
                        case 'toggle-check':
                            toggleGoal(gridId, index);
                            break;
                        case 'delete':
                            if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç›®æ¨™å—ï¼Ÿ')) deleteGoal(gridId, index);
                            break;
                        case 'edit':
                            startEditGoal(goalItem, gridId, index);
                            break;
                        case 'toggle-frog':
                            toggleFrogMark(gridId, index);
                            break;
                        case 'change-link':
                        case 'change-link-btn':
                            changeYearGoalLink(gridId, index);
                            break;
                    }
                });
            });

            // æ‹–æ›³äº‹ä»¶
            document.querySelectorAll('.goal-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
            });
            
            // æœˆåº¦ç›®æ¨™è¼¸å…¥æ™‚é¡¯ç¤ºåƒè€ƒ
            if (currentMode === 'month') {
                document.querySelectorAll('.add-input').forEach(input => {
                    input.addEventListener('focus', (e) => showReferenceTooltip(e.target.dataset.id, e.target));
                    input.addEventListener('blur', () => setTimeout(hideReferenceTooltip, 200));
                });
            }
        }
        
        function handleImageUpload(gridId, file) {
            if (!file || !file.type.startsWith('image/')) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                // å„²å­˜ç‚º Base64 æ•¸æ“š
                setBackgroundImage(gridId, e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function setBackgroundImage(gridId, imageData) {
            const bgImages = getBackgroundImages();

            if (currentMode === 'year') {
                bgImages.year[gridId] = imageData;
            } else {
                bgImages.month[currentMonth][gridId] = imageData;
            }
            saveData();
            renderGrid();
        }

        function deleteBackgroundImage(gridId) {
            const bgImages = getBackgroundImages();

            if (currentMode === 'year') {
                delete bgImages.year[gridId];
            } else {
                delete bgImages.month[currentMonth][gridId];
            }
            saveData();
            renderGrid();
        }

        function toggleFrogMark(gridId, index) {
            const data = currentMode === 'year' ? getCurrentYearData() : getCurrentMonthData()[currentMonth];
            const goal = data[gridId].goals[index];
            
            goal.hasFrog = !goal.hasFrog;
            saveData();
            renderGrid();
        }

        function addGoal(gridId) {
            const input = document.querySelector(`.add-input[data-id="${gridId}"]`);
            const text = input.value.trim();
            if (!text) return;
            
            if (currentMode === 'year') {
                // å¹´åº¦ç›®æ¨™ç›´æ¥æ–°å¢
                const yearData = getCurrentYearData();
                yearData[gridId].goals.push({
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                    text: text,
                    completed: false,
                    monthGoals: [],
                    hasFrog: false
                });
                input.value = '';
                saveData();
                renderGrid();
            } else {
                // æœˆåº¦ç›®æ¨™ï¼šå½ˆå‡ºé—œè¯é¸æ“‡å™¨
                input.value = ''; // å…ˆæ¸…ç©ºè¼¸å…¥æ¡†ï¼Œé¿å…äºŒæ¬¡æäº¤
                showLinkSelectorModal(gridId, text, null);
            }
        }
        
        // --- æ‹–æ›³æ’åºé‚è¼¯ (éœ€æ±‚ 2) ---
        function handleDragStart(e) {
            draggedElement = this;
            e.dataTransfer.effectAllowed = 'move';
            this.classList.add('dragging');
        }

        function handleDragEnd() {
            draggedElement.classList.remove('dragging');
            document.querySelectorAll('.goal-item').forEach(item => {
                item.classList.remove('drag-over-top', 'drag-over-bottom');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            if (this.dataset.gridId !== draggedElement.dataset.gridId) return; // åªèƒ½åœ¨åŒä¸€å€‹æ ¼å­å…§æ‹–æ›³

            const rect = this.getBoundingClientRect();
            const y = e.clientY - rect.top;
            
            document.querySelectorAll('.goal-item').forEach(item => {
                item.classList.remove('drag-over-top', 'drag-over-bottom');
            });

            if (y < rect.height / 2) {
                this.classList.add('drag-over-top');
            } else {
                this.classList.add('drag-over-bottom');
            }
        }
        
        function handleDragLeave() {
            this.classList.remove('drag-over-top', 'drag-over-bottom');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            if (this.dataset.gridId !== draggedElement.dataset.gridId) return;

            const targetIndex = parseInt(this.dataset.index);
            const sourceIndex = parseInt(draggedElement.dataset.index);
            const gridId = this.dataset.gridId;
            
            let goals = currentMode === 'year' ? getCurrentYearData()[gridId].goals : getCurrentMonthData()[currentMonth][gridId].goals;
            
            const rect = this.getBoundingClientRect();
            const y = e.clientY - rect.top;
            
            const targetPos = y < rect.height / 2 ? targetIndex : targetIndex + 1;
            
            if (sourceIndex === targetPos || sourceIndex === targetPos - 1) return;
            
            const [draggedGoal] = goals.splice(sourceIndex, 1);
            
            // èª¿æ•´ç›®æ¨™ä½ç½®
            if (targetPos > sourceIndex) {
                goals.splice(targetPos - 1, 0, draggedGoal);
            } else {
                goals.splice(targetPos, 0, draggedGoal);
            }

            saveData();
            renderGrid();
        }
        
        // --- ç·¨è¼¯é‚è¼¯ (éœ€æ±‚ 1) ---
        function startEditGoal(goalItem, gridId, index) {
            goalItem.classList.add('editing');
            const input = goalItem.querySelector('.goal-text-input');
            input.focus();
            input.select();
            
            input.onblur = () => finishEditGoal(goalItem, gridId, index, input.value);
        }

        function finishEditGoal(goalItem, gridId, index, newText) {
            goalItem.classList.remove('editing');
            newText = newText.trim();
            if (!newText) {
                renderGrid(); // ä¿æŒåŸç‹€
                return;
            }

            const data = currentMode === 'year' ? getCurrentYearData() : getCurrentMonthData()[currentMonth];
            const goal = data[gridId].goals[index];
            goal.text = newText;
            
            // æ›´æ–°å¹´åº¦ç›®æ¨™ä¸‹çš„æœˆåº¦ç›®æ¨™é¡¯ç¤º (å¦‚æœé—œè¯å­˜åœ¨)
            if (currentMode === 'month' && goal.yearGoalId) {
                const yearGoal = getCurrentYearData()[gridId].goals.find(g => g.id === goal.yearGoalId);
                if (yearGoal && yearGoal.monthGoals) {
                    const monthGoalEntry = yearGoal.monthGoals.find(mg => mg.goalId === goal.id);
                    if (monthGoalEntry) monthGoalEntry.text = newText;
                }
            }
            
            saveData();
            renderGrid();
        }

        // --- æœˆåº¦ç›®æ¨™é—œè¯é‚è¼¯ (éœ€æ±‚ 3, 4.3, 14) ---
        let pendingNewGoal = null;
        let editingGoalInfo = null;
        
        function showLinkSelectorModal(gridId, goalText, editingIndex) {
            const yearGoals = getCurrentYearData()[gridId].goals;
            const modal = document.getElementById('linkSelectorModal');
            const optionsDiv = document.getElementById('yearGoalOptions');
            const title = document.getElementById('linkSelectorTitle');
            
            pendingNewGoal = editingIndex === null ? { gridId, goalText } : null;
            editingGoalInfo = editingIndex !== null ? { gridId, index: editingIndex } : null;

            title.textContent = editingIndex === null ? `æ–°å¢æœˆåº¦ç›®æ¨™ï¼šé—œè¯å¹´åº¦ç›®æ¨™` : `ä¿®æ”¹é—œè¯ï¼š${goalText}`;
            
            let currentYearGoalId = null;
            if (editingIndex !== null) {
                currentYearGoalId = getCurrentMonthData()[currentMonth][gridId].goals[editingIndex].yearGoalId;
            }

            let optionsHtml = yearGoals.map((goal, index) => {
                const isChecked = currentYearGoalId === goal.id ? 'checked' : '';
                return `
                    <div class="year-goal-option" data-id="${goal.id}">
                        <input type="radio" name="yearGoalLink" value="${goal.id}" id="yg_${goal.id}" ${isChecked}>
                        <label for="yg_${goal.id}">ã€å¹´åº¦ç›®æ¨™ ${index + 1}ã€‘${goal.text}</label>
                    </div>
                `;
            }).join('');
            
            const noLinkChecked = currentYearGoalId === null ? 'checked' : '';
            optionsHtml += `
                <div class="year-goal-option" data-id="none">
                    <input type="radio" name="yearGoalLink" value="" id="yg_none" ${noLinkChecked}>
                    <label for="yg_none">ä¸é—œè¯å¹´åº¦ç›®æ¨™</label>
                </div>
            `;

            optionsDiv.innerHTML = optionsHtml;
            
            // ç›£è½å–®é¸æ¡†è®ŠåŒ–
            optionsDiv.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.onchange = (e) => {
                    const newYearGoalId = e.target.value || null;
                    if (editingGoalInfo) {
                        // ä¿®æ”¹ç¾æœ‰é—œè¯ (éœ€æ±‚ 14)
                        updateMonthGoalLink(editingGoalInfo.gridId, editingGoalInfo.index, newYearGoalId);
                    } else if (pendingNewGoal) {
                        // æ–°å¢æœˆåº¦ç›®æ¨™
                        addMonthGoalWithLink(pendingNewGoal.gridId, pendingNewGoal.goalText, newYearGoalId);
                    }
                    hideLinkSelectorModal();
                };
            });
            
            modal.style.display = 'flex';
        }
        
        function hideLinkSelectorModal() {
            document.getElementById('linkSelectorModal').style.display = 'none';
            pendingNewGoal = null;
            editingGoalInfo = null;
        }

        function changeYearGoalLink(gridId, index) {
            const goal = getCurrentMonthData()[currentMonth][gridId].goals[index];
            showLinkSelectorModal(gridId, goal.text, index);
        }

        function addMonthGoalWithLink(gridId, text, yearGoalId) {
            const monthData = getCurrentMonthData();
            const yearData = getCurrentYearData();

            const newGoal = {
                id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                yearGoalId: yearGoalId,
                text: text,
                completed: false,
                hasFrog: false
            };
            
            // 1. æ–°å¢åˆ°æœˆåº¦ç›®æ¨™
            monthData[currentMonth][gridId].goals.push(newGoal);

            // 2. æ›´æ–°å¹´åº¦ç›®æ¨™çš„æœˆåº¦åˆ—è¡¨
            if (yearGoalId) {
                const yearGoal = yearData[gridId].goals.find(g => g.id === yearGoalId);
                if (yearGoal) {
                    if (!yearGoal.monthGoals) yearGoal.monthGoals = [];
                    yearGoal.monthGoals.push({
                        month: currentMonth,
                        text: text,
                        goalId: newGoal.id
                    });
                }
            }
            saveData();
            renderGrid();
        }

        function updateMonthGoalLink(gridId, goalIndex, newYearGoalId) {
            const monthData = getCurrentMonthData();
            const yearData = getCurrentYearData();
            const goal = monthData[currentMonth][gridId].goals[goalIndex];
            
            const oldYearGoalId = goal.yearGoalId;
            goal.yearGoalId = newYearGoalId;
            
            // å¾èˆŠå¹´åº¦ç›®æ¨™çš„æœˆåº¦åˆ—è¡¨ä¸­ç§»é™¤
            if (oldYearGoalId) {
                const oldYearGoal = yearData[gridId].goals.find(g => g.id === oldYearGoalId);
                if (oldYearGoal) {
                    oldYearGoal.monthGoals = oldYearGoal.monthGoals.filter(
                        mg => mg.goalId !== goal.id || mg.month !== currentMonth
                    );
                }
            }
            
            // åŠ å…¥æ–°å¹´åº¦ç›®æ¨™çš„æœˆåº¦åˆ—è¡¨
            if (newYearGoalId) {
                const newYearGoal = yearData[gridId].goals.find(g => g.id === newYearGoalId);
                if (newYearGoal) {
                    if (!newYearGoal.monthGoals) newYearGoal.monthGoals = [];
                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ (é¿å…é‡è¤‡)
                    if (!newYearGoal.monthGoals.find(mg => mg.goalId === goal.id && mg.month === currentMonth)) {
                        newYearGoal.monthGoals.push({
                            month: currentMonth,
                            text: goal.text,
                            goalId: goal.id
                        });
                    }
                }
            }
            saveData();
            renderGrid();
        }
        
        // --- åˆªé™¤/å®Œæˆé‚è¼¯ ---

        function toggleGoal(gridId, index) {
            const data = currentMode === 'year' ? getCurrentYearData() : getCurrentMonthData()[currentMonth];
            const goal = data[gridId].goals[index];
            goal.completed = !goal.completed;
            
            const allGoals = GRID_CONFIG.filter(c => !c.isCenter).flatMap(c => data[c.id].goals);
            const completedGoals = allGoals.filter(g => g.completed);
            
            // ç…™èŠ±æ•ˆæœ (éœ€æ±‚ 7)
            if (goal.completed && allGoals.length > 0 && completedGoals.length === allGoals.length) {
                triggerFireworks();
            }
            
            saveData();
            renderGrid();
            updateStats();
        }

        function deleteGoal(gridId, index) {
            const data = currentMode === 'year' ? getCurrentYearData() : getCurrentMonthData()[currentMonth];
            const goal = data[gridId].goals[index];
            
            if (currentMode === 'year') {
                // å¦‚æœæ˜¯åˆªé™¤å¹´åº¦ç›®æ¨™ï¼Œéœ€åŒæ­¥åˆªé™¤æ‰€æœ‰æœˆåº¦ç›®æ¨™ä¸­å°å®ƒçš„é—œè¯
                const monthData = getCurrentMonthData();
                for(let month=1; month<=12; month++) {
                    monthData[month][gridId].goals = monthData[month][gridId].goals.filter(mg => mg.yearGoalId !== goal.id);
                }
            } else {
                // å¦‚æœæ˜¯åˆªé™¤æœˆåº¦ç›®æ¨™ï¼Œéœ€åŒæ­¥ç§»é™¤å¹´åº¦ç›®æ¨™ä¸­çš„æœˆåº¦åˆ—è¡¨é …ç›®
                if (goal.yearGoalId) {
                    const yearGoal = getCurrentYearData()[gridId].goals.find(g => g.id === goal.yearGoalId);
                    if (yearGoal && yearGoal.monthGoals) {
                        yearGoal.monthGoals = yearGoal.monthGoals.filter(mg => mg.goalId !== goal.id);
                    }
                }
            }

            data[gridId].goals.splice(index, 1);
            
            // ç”±æ–¼ splice æœƒæ”¹è®Š indexï¼Œå¿…é ˆé‡æ–°æ¸²æŸ“
            saveData();
            renderGrid();
            updateStats();
        }

        // --- è¼”åŠ©å‡½å¼ ---

        function showReferenceTooltip(gridId, inputElement) {
            const tooltip = document.getElementById('referenceTooltip');
            const config = GRID_CONFIG.find(c => c.id === gridId);
            if (!config || config.isCenter) return;
            
            const yearGoals = getCurrentYearData()[gridId].goals;
            const prevMonthGoals = currentMonth > 1 ? getCurrentMonthData()[currentMonth - 1][gridId].goals : [];
            
            let content = `<h4>å¹´åº¦ç›®æ¨™ï¼š${config.title}</h4>`;
            
            // å¹´åº¦ç›®æ¨™åƒè€ƒ
            if (yearGoals.length > 0) {
                content += `<div style="margin-bottom: 15px;">
                    ${yearGoals.map((g, i) => `<div class="reference-goal-item">ã€${i+1}ã€‘${g.text}</div>`).join('')}
                </div>`;
            } else {
                content += `<p style="font-style: italic; color: var(--text-secondary);">å°šæœªè¨­å®šå¹´åº¦ç›®æ¨™</p>`;
            }
            
            // å‰æœˆç›®æ¨™åƒè€ƒ
            if (prevMonthGoals.length > 0) {
                content += `<h4>${currentMonth - 1}æœˆç›®æ¨™ï¼š${config.title}</h4>
                    <div style="margin-bottom: 15px;">
                        ${prevMonthGoals.map((g, i) => `<div class="reference-goal-item">ã€${i+1}ã€‘${g.text} ${g.completed ? '(âœ“)' : ''}</div>`).join('')}
                    </div>`;
            }

            tooltip.innerHTML = content;
            
            // èª¿æ•´ä½ç½®ï¼šå›ºå®šåœ¨è¼¸å…¥æ¡†å³ä¸Šæ–¹
            const rect = inputElement.getBoundingClientRect();
            tooltip.style.left = `${rect.right + 10}px`;
            tooltip.style.top = `${rect.top - tooltip.offsetHeight}px`;
            tooltip.classList.add('show');
        }

        function hideReferenceTooltip() {
            document.getElementById('referenceTooltip').classList.remove('show');
        }
        
        // --- çµ±è¨ˆèˆ‡å‹‰å‹µ (éœ€æ±‚ 8, 10) ---

        function updateStats() {
            const yearData = getCurrentYearData();
            const monthData = getCurrentMonthData();

            // å¹´åº¦ç›®æ¨™çµ±è¨ˆ
            let yearTotal = 0;
            let yearCompleted = 0;
            GRID_CONFIG.filter(c => !c.isCenter).forEach(c => {
                const goals = yearData[c.id].goals;
                yearTotal += goals.length;
                yearCompleted += goals.filter(g => g.completed).length;
            });

            const yearPercent = yearTotal > 0 ? Math.round((yearCompleted / yearTotal) * 100) : 0;
            
            document.getElementById('yearTotal').textContent = yearTotal;
            document.getElementById('yearCompleted').textContent = yearCompleted;
            document.getElementById('yearCompletionPercent').textContent = `${yearPercent}%`;
            document.getElementById('yearProgressBar').style.width = `${yearPercent}%`;

            // å…¨å¹´æœˆåº¦ç›®æ¨™çµ±è¨ˆ
            let allMonthTotal = 0;
            let allMonthCompleted = 0;
            for (let month = 1; month <= 12; month++) {
                GRID_CONFIG.filter(c => !c.isCenter).forEach(c => {
                    const goals = monthData[month][c.id].goals;
                    allMonthTotal += goals.length;
                    allMonthCompleted += goals.filter(g => g.completed).length;
                });
            }
            const allMonthPercent = allMonthTotal > 0 ? Math.round((allMonthCompleted / allMonthTotal) * 100) : 0;

            document.getElementById('allMonthTotal').textContent = allMonthTotal;
            document.getElementById('allMonthCompleted').textContent = allMonthCompleted;
            document.getElementById('allMonthCompletionPercent').textContent = `${allMonthPercent}%`;
            document.getElementById('allMonthProgressBar').style.width = `${allMonthPercent}%`;
            
            // å‹‰å‹µçš„è©± (éœ€æ±‚ 10)
            const encouragement = getEncouragement(yearPercent);
            document.getElementById('encouragementText').textContent = encouragement;
        }

        function getEncouragement(percent) {
            if (percent === 100) return "ğŸ‰ åœ“æ»¿é”æˆï¼å¹´åº¦ç›®æ¨™å®Œç¾æ”¶å®˜ï¼Œå“è¶Šçš„åŸ·è¡ŒåŠ›ï¼";
            if (percent >= 90) return "ğŸ† æ¥è¿‘å®Œç¾ï¼åªéœ€æœ€å¾Œçš„è¡åˆºï¼Œå¹´åº¦ç›®æ¨™å°±åœ¨çœ¼å‰ï¼";
            if (percent >= 80) return "ğŸŒŸ è¡¨ç¾å‡ºè‰²ï¼ä½ å·²å®Œæˆå¤§éƒ¨åˆ†æŒ‘æˆ°ï¼Œç¹¼çºŒä¿æŒï¼";
            if (percent >= 70) return "ğŸš€ ç©©å¥å‰é€²ï¼è·é›¢çµ‚é»ç·šä¸é äº†ï¼ŒåŠ é€Ÿå¯¦ç¾é¡˜æ™¯ï¼";
            if (percent >= 60) return "ğŸ’ª è¶…è¶Šå…­æˆï¼æˆæœæ–ç„¶ï¼Œä½ çš„åŠªåŠ›æ²’æœ‰ç™½è²»ã€‚";
            if (percent >= 50) return "ğŸ¯ é”åˆ°åŠç¨‹ï¼æˆåŠŸè·¨è¶Šé‡Œç¨‹ç¢‘ï¼Œä¸‹åŠç¨‹ç›®æ¨™æ˜ç¢ºï¼";
            if (percent >= 40) return "ğŸ“ˆ ç©æ¥µå‘ä¸Šï¼æ­£ç©©æ­¥ç´¯ç©ï¼Œä½ çš„æ¯ä¸€æ­¥éƒ½åœ¨æˆé•·ã€‚";
            if (percent >= 30) return "ğŸŒ± ä¿æŒå‹•åŠ›ï¼å·²ç¶“æœ‰å¾ˆå¥½çš„é–‹å§‹ï¼Œå …æŒå°±æ˜¯å‹åˆ©ï¼";
            if (percent >= 20) return "ğŸ’¡ è‰¯å¥½é–‹ç«¯ï¼æ˜ç¢ºç›®æ¨™ï¼Œå°ˆæ³¨åŸ·è¡Œï¼Œä½ æœƒåšå¾—æ›´å¥½ï¼";
            if (percent >= 10) return "ğŸƒâ€â™‚ï¸ å·²ç¶“ä¸Šè·¯ï¼è¬äº‹é–‹é ­é›£ï¼Œä½ å·²é‚å‡ºé—œéµä¸€æ­¥ã€‚";
            return "âœ¨ è¨­å®šç›®æ¨™ï¼Œå°±æ˜¯é‚å‘æˆåŠŸçš„ç¬¬ä¸€æ­¥ï¼";
        }
        
        // --- ç…™èŠ±å‹•ç•« (éœ€æ±‚ 7) ---
        const canvas = document.getElementById('fireworks');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let isFireworksActive = false;

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', initCanvas);

        class Particle {
            // ... (ç²’å­é¡åˆ¥å¯¦ç¾, èˆ‡å‰ä¸€å€‹å›æ‡‰çš„ä»£ç¢¼ç›¸åŒï¼Œçœç•¥ç´°ç¯€) ...
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.velocity = { x: (Math.random() - 0.5) * 8, y: (Math.random() - 0.5) * 8 };
                this.alpha = 1; this.decay = Math.random() * 0.015 + 0.015;
                this.radius = Math.random() * 3 + 2;
            }
            draw() {
                ctx.save(); ctx.globalAlpha = this.alpha; ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color; ctx.fill(); ctx.restore();
            }
            update() {
                this.velocity.y += 0.1; this.x += this.velocity.x;
                this.y += this.velocity.y; this.alpha -= this.decay;
            }
        }

        function createFirework(x, y) {
            const colors = ['#ff6b6b', '#4ecdc4', '#f7dc6f', '#bb8fce', '#85c1e2', '#eb5e7f', 'white'];
            const particleCount = 60;
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle(x, y, colors[Math.floor(Math.random() * colors.length)]));
            }
        }

        function animateFireworks() {
            if (!isFireworksActive) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles = [];
                return;
            }

            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            particles.forEach((particle, index) => {
                if (particle.alpha <= 0) {
                    particles.splice(index, 1);
                } else {
                    particle.update();
                    particle.draw();
                }
            });

            requestAnimationFrame(animateFireworks);
        }

        function triggerFireworks() {
            isFireworksActive = true;
            const fireworkCount = 8;
            let count = 0;
            
            const interval = setInterval(() => {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height * 0.6;
                createFirework(x, y);
                
                count++;
                if (count >= fireworkCount) {
                    clearInterval(interval);
                    setTimeout(() => {
                        isFireworksActive = false;
                    }, 3000); // 3ç§’å¾Œåœæ­¢
                }
            }, 200);

            animateFireworks();
        }
        
        // --- åˆå§‹åŒ–ä¸»ç¨‹å¼ ---

        async function initializeApp() {
            // è¨­ç½®å¹´ä»½é¸æ“‡å™¨
            const yearSelect = document.getElementById('yearSelect');
            const currentYearValue = new Date().getFullYear();
            for (let year = currentYearValue - 5; year <= currentYearValue + 5; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}å¹´`;
                if (year === currentYearValue) option.selected = true;
                yearSelect.appendChild(option);
            }
            currentYear = currentYearValue;
            
            // åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨
            document.querySelectorAll('.month-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.month-btn[data-month="${currentMonth}"]`).classList.add('active');

            // è¼‰å…¥è³‡æ–™ä¸¦æ¸²æŸ“
            await loadData();
            renderGrid();
            updateStats();
            
            // äº‹ä»¶ç›£è½
            document.getElementById('yearSelect').onchange = async (e) => {
                currentYear = parseInt(e.target.value);
                await loadData(); // è¼‰å…¥æ–°å¹´ä»½è³‡æ–™
                renderGrid();
                updateStats();
            };
            document.querySelectorAll('.mode-btn').forEach(btn => btn.onclick = (e) => switchMode(e.currentTarget.dataset.mode));
            document.querySelectorAll('.month-btn').forEach(btn => btn.onclick = (e) => switchMonth(parseInt(e.currentTarget.dataset.month)));
            document.querySelectorAll('.theme-btn').forEach(btn => btn.onclick = (e) => switchTheme(e.currentTarget.dataset.theme));
            document.querySelectorAll('.page-btn').forEach(btn => btn.onclick = (e) => switchPage(e.currentTarget.dataset.page));
            
            // å•Ÿç”¨ Canvas
            initCanvas();
        }
        
        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.mode-btn[data-mode="${mode}"]`).classList.add('active');
            document.getElementById('monthSelector').style.display = (mode === 'month' ? 'flex' : 'none');
            renderGrid();
        }
        
        function switchMonth(month) {
            currentMonth = month;
            document.querySelectorAll('.month-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.month-btn[data-month="${month}"]`).classList.add('active');
            renderGrid();
        }
        
        function switchTheme(theme) {
            document.body.className = theme;
            allYearsData[currentYear].theme = theme; // ä¿å­˜ä¸»é¡Œåˆ°ç•¶å‰å¹´ä»½æ•¸æ“š
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.theme-btn[data-theme="${theme}"]`).classList.add('active');
            saveData();
        }
        
        function switchPage(page) {
            document.querySelectorAll('.page-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.page-btn[data-page="${page}"]`).classList.add('active');
            document.querySelectorAll('.page-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${page}Page`).classList.add('active');
            if (page === 'stats') updateStats();
        }

        initializeApp();

    </script>
</body>
</html>
