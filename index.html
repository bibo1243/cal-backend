<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹å®®æ ¼å¹´åº¦è¦åŠƒç³»çµ± - Cal Planner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* CSS è®Šé‡å®šç¾© */
        :root {
            --bg-primary: #f5f8f5; --bg-secondary: #ffffff; --text-primary: #2d4a2b; --text-secondary: #5a7658;
            --accent: #6b9e78; --accent-light: #d8e8db; --accent-dark: #4a7552;
            --border: #d4e0d4; --shadow: rgba(45, 74, 43, 0.08);
            --center-bg: linear-gradient(135deg, rgba(107, 158, 120, 0.95) 0%, rgba(74, 117, 82, 0.95) 100%);
            --month-badge: #88b894;
        }
        
        /* 8ç¨®é¢¨æ ¼ */
        body.bamboo { --bg-primary: #f5f8f5; --accent: #6b9e78; --center-bg: linear-gradient(135deg, #6b9e78 0%, #4a7552 100%); }
        body.sakura { --bg-primary: #fff0f5; --text-primary: #5d4157; --accent: #ffb7c5; --accent-light: #ffe4e1; --center-bg: linear-gradient(135deg, #ffb7c5 0%, #db7093 100%); }
        body.lotus { --bg-primary: #f0f8ff; --text-primary: #2c3e50; --accent: #87ceeb; --accent-light: #e0ffff; --center-bg: linear-gradient(135deg, #87ceeb 0%, #4682b4 100%); }
        body.sunset { --bg-primary: #fff5e6; --text-primary: #5d4037; --accent: #ffab91; --accent-light: #ffe0b2; --center-bg: linear-gradient(135deg, #ffab91 0%, #d84315 100%); }
        body.ocean { --bg-primary: #e3f2fd; --text-primary: #0d47a1; --accent: #2196f3; --accent-light: #bbdefb; --center-bg: linear-gradient(135deg, #2196f3 0%, #1565c0 100%); }
        body.lavender { --bg-primary: #f3e5f5; --text-primary: #4a148c; --accent: #ce93d8; --accent-light: #f3e5f5; --center-bg: linear-gradient(135deg, #ce93d8 0%, #8e24aa 100%); }
        body.autumn { --bg-primary: #fff3e0; --text-primary: #3e2723; --accent: #ffcc80; --accent-light: #ffe0b2; --center-bg: linear-gradient(135deg, #ffcc80 0%, #e65100 100%); }
        body.midnight { --bg-primary: #263238; --bg-secondary: #37474f; --text-primary: #eceff1; --text-secondary: #b0bec5; --accent: #80cbc4; --accent-light: #546e7a; --border: #455a64; --center-bg: linear-gradient(135deg, #263238 0%, #009688 100%); }

        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; padding: 30px 20px; transition: all 0.5s ease; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; }
        
        .controls-wrapper { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 8px 16px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; border-radius: 20px; transition: 0.2s; font-size: 0.9rem; }
        .btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-danger { background: #e74c3c !important; color: white !important; border-color: #c0392b !important; }

        /* é¢¨æ ¼è‰²ç¥¨ */
        .theme-selector { display: flex; gap: 8px; background: var(--bg-secondary); padding: 8px 12px; border-radius: 30px; box-shadow: 0 2px 10px var(--shadow); }
        .theme-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; position: relative; }
        .theme-dot:hover { transform: scale(1.2); }
        .theme-dot::after { content: attr(data-title); position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; font-size: 10px; border-radius: 4px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .theme-dot:hover::after { opacity: 1; }

        /* ä¹å®®æ ¼èˆ‡æ ¼å­ */
        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .grid-item { background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 16px; padding: 20px; min-height: 350px; display: flex; flex-direction: column; box-shadow: 0 4px 15px var(--shadow); transition: 0.3s; position: relative; }
        .grid-item:hover { border-color: var(--accent); }
        .grid-item.center { background: var(--center-bg); border: none; color: white; justify-content: center; align-items: center; }
        .grid-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 10px; border-bottom: 2px solid var(--border); padding-bottom: 5px; }
        .grid-item.center .grid-title { border: none; color: white; }

        /* ç›®æ¨™åˆ—è¡¨ */
        .goals-list { flex: 1; list-style: none; padding: 0; overflow-y: auto; margin-bottom: 15px; max-height: 200px; }
        .goal-item { display: flex; gap: 8px; padding: 6px 0; border-bottom: 1px dashed var(--border); align-items: flex-start; flex-wrap: wrap; }
        .goal-header { display: flex; width: 100%; align-items: flex-start; gap: 8px; }
        .goal-number { min-width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; margin-top: 3px; }
        .goal-checkbox { width: 16px; height: 16px; border: 2px solid var(--accent); border-radius: 4px; cursor: pointer; margin-top: 4px; flex-shrink: 0; }
        .goal-checkbox.checked { background: var(--accent); }
        
        .goal-text-wrapper { flex: 1; min-width: 0; }
        .goal-text { word-break: break-word; cursor: pointer; }
        .goal-frog-icon { display: inline-block; animation: hop 1s infinite; margin-right: 5px; font-size: 1.1em; }
        @keyframes hop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        /* é—œè¯é¡¯ç¤º */
        .linked-goal-info { font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px; margin-left: 28px; background: rgba(0,0,0,0.03); padding: 2px 6px; border-radius: 4px; width: 100%; }

        /* æŒ‰éˆ•å€ */
        .action-btns { display: flex; gap: 4px; margin-left: auto; }
        .mini-btn { padding: 2px 6px; font-size: 12px; border-radius: 4px; border: 1px solid var(--border); background: transparent; cursor: pointer; color: var(--text-secondary); }
        .mini-btn:hover { background: var(--accent-light); color: var(--accent-dark); }
        .btn-frog.active { background: #d4edda; border-color: #28a745; color: #28a745; }

        /* åº•éƒ¨æ“ä½œå€ */
        .grid-footer { margin-top: auto; }
        .add-input-wrapper { display: flex; gap: 5px; margin-bottom: 10px; }
        .add-input { flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); }
        .add-btn { padding: 8px 12px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; }

        /* åœ–ç‰‡å€ (æ­£æ–¹å½¢, ä¸‹æ–¹) */
        .image-display-area { width: 100%; aspect-ratio: 1 / 1; border: 2px dashed var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; margin-top: 5px; background: rgba(0,0,0,0.02); cursor: pointer; }
        .image-display-area:hover { background: rgba(0,0,0,0.05); border-color: var(--accent); }
        .image-display-area img { width: 100%; height: 100%; display: block; object-fit: contain; }
        .image-placeholder { color: var(--text-secondary); font-size: 0.8rem; pointer-events: none; }
        .img-controls { position: absolute; bottom: 5px; right: 5px; display: flex; gap: 5px; opacity: 0; transition: 0.3s; }
        .image-display-area:hover .img-controls { opacity: 1; }

        /* é—œè¯é¸æ“‡ Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-secondary); padding: 25px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; color: var(--accent); }
        .link-option { padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .link-option:hover { background: var(--accent-light); }
        
        .core-word-display { font-size: 4rem; font-weight: bold; background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; text-align: center; width: 100%; max-width: 200px; padding: 10px; }

        @media (max-width: 900px) { .grid-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .grid-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body class="bamboo">
    <div class="container">
        <header>
            <h1>ä¹å®®æ ¼å¹´åº¦è¦åŠƒ</h1>
            <div class="controls-wrapper">
                <button class="btn active" onclick="switchPage('planner')">ğŸ“‹ è¦åŠƒ</button>
                <button class="btn" onclick="switchPage('stats')">ğŸ“Š çµ±è¨ˆ</button>
                <select id="yearSelect" class="btn" style="padding: 8px;"></select>
                <div class="theme-selector">
                    <div class="theme-dot" style="background:#6b9e78" data-theme="bamboo" data-title="ç«¹æ—"></div>
                    <div class="theme-dot" style="background:#ffb7c5" data-theme="sakura" data-title="æ«»èŠ±"></div>
                    <div class="theme-dot" style="background:#87ceeb" data-theme="lotus" data-title="è“®æ± "></div>
                    <div class="theme-dot" style="background:#ffab91" data-theme="sunset" data-title="æ™šéœ"></div>
                    <div class="theme-dot" style="background:#2196f3" data-theme="ocean" data-title="æ·±æµ·"></div>
                    <div class="theme-dot" style="background:#ce93d8" data-theme="lavender" data-title="è–°è¡£è‰"></div>
                    <div class="theme-dot" style="background:#ffcc80" data-theme="autumn" data-title="ç§‹æ¥“"></div>
                    <div class="theme-dot" style="background:#263238" data-theme="midnight" data-title="æš—å¤œ"></div>
                </div>
            </div>
            <div class="controls-wrapper">
                <button class="btn btn-primary" onclick="handleBackup()">ğŸ“¥ å‚™ä»½</button>
                <button class="btn btn-primary" onclick="document.getElementById('restoreInput').click()">ğŸ“¤ é‚„åŸ</button>
                <input type="file" id="restoreInput" accept=".json" style="display:none" onchange="handleRestore(this)">
                <button class="btn btn-danger" onclick="handleClearData()">âš ï¸ æ¸…ç©ºè³‡æ–™</button>
            </div>
        </header>

        <div id="plannerPage">
            <div class="controls-wrapper">
                <button class="btn active mode-btn" data-mode="year" onclick="switchMode('year')">ğŸ“… å¹´åº¦</button>
                <button class="btn mode-btn" data-mode="month" onclick="switchMode('month')">ğŸ“† æœˆåº¦</button>
            </div>
            <div id="monthSelector" class="controls-wrapper" style="display:none;">
                <!-- æœˆä»½æŒ‰éˆ• JS ç”Ÿæˆ -->
            </div>
            <div id="gridContainer" class="grid-container"></div>
        </div>

        <div id="statsPage" style="display:none;">
            <div class="grid-item" style="width: 100%; text-align: center;">
                <h2>å®Œæˆé€²åº¦</h2>
                <div id="statsContent"></div>
            </div>
        </div>
    </div>

    <!-- é—œè¯é¸æ“‡ Modal -->
    <div id="linkModal" class="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-title">é¸æ“‡è¦é—œè¯çš„å¹´åº¦ç›®æ¨™</div>
            <div id="linkOptionsList"></div>
            <button class="btn" style="margin-top:15px; float:right;" onclick="document.getElementById('linkModal').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>

    <script>
        const GRID_CONFIG = [
            { id: 'learn', title: 'å­¸ç¿’&æˆé•·' }, { id: 'experience', title: 'é«”é©—&çªç ´' }, { id: 'relax', title: 'ä¼‘é–’&æ”¾é¬†' },
            { id: 'family', title: 'å®¶åº­&ç”Ÿæ´»' }, { id: 'core', title: 'æ ¸å¿ƒè©', isCenter: true }, { id: 'work', title: 'å·¥ä½œ&äº‹æ¥­' },
            { id: 'social', title: 'äººéš›&ç¤¾ç¾¤' }, { id: 'finance', title: 'è²¡å‹™&ç†è²¡' }, { id: 'health', title: 'å¥åº·&èº«é«”' }
        ];

        let currentMode = 'year';
        let currentMonth = new Date().getMonth() + 1;
        let currentYear = new Date().getFullYear();
        let allYearsData = {}; 
        let pendingLink = null; // æš«å­˜æ­£åœ¨è¨­å®šé—œè¯çš„ç›®æ¨™è³‡è¨Š

        async function initApp() {
            initYearSelector();
            initMonthSelector();
            setupThemeListeners();
            await loadData();
            renderGrid();
        }

        function initYearSelector() {
            const select = document.getElementById('yearSelect');
            for (let y = 2020; y <= 2100; y++) {
                const opt = document.createElement('option');
                opt.value = y; opt.textContent = `${y}å¹´`;
                if (y === currentYear) opt.selected = true;
                select.appendChild(opt);
            }
            select.onchange = async (e) => { currentYear = parseInt(e.target.value); await loadData(); renderGrid(); };
        }

        function initMonthSelector() {
            const container = document.getElementById('monthSelector');
            for(let i=1; i<=12; i++) {
                const btn = document.createElement('button');
                btn.className = `btn ${i === currentMonth ? 'active' : ''}`;
                btn.textContent = `${i}æœˆ`;
                btn.onclick = () => {
                    currentMonth = i;
                    document.querySelectorAll('#monthSelector .btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderGrid();
                };
                container.appendChild(btn);
            }
        }

        function setupThemeListeners() {
            document.querySelectorAll('.theme-dot').forEach(dot => {
                dot.onclick = () => {
                    const theme = dot.dataset.theme;
                    document.body.className = theme;
                    if(allYearsData[currentYear]) { allYearsData[currentYear].theme = theme; saveData(); }
                };
            });
        }

        function initDataStructure(year) {
            if (allYearsData[year]) return;
            const yearData = {}; const monthData = {}; const backgroundImages = { year: {}, month: {} };
            GRID_CONFIG.forEach(c => { yearData[c.id] = { title: c.title, coreWord: '', goals: [] }; });
            for(let m=1; m<=12; m++) {
                monthData[m] = {};
                GRID_CONFIG.forEach(c => { monthData[m][c.id] = { goals: [] }; });
                backgroundImages.month[m] = {};
            }
            allYearsData[year] = { yearData, monthData, theme: 'bamboo', backgroundImages };
        }

        async function loadData() {
            try {
                const res = await fetch(`/api/plan/${currentYear}`);
                if (res.status === 404) { initDataStructure(currentYear); } 
                else {
                    const data = await res.json();
                    allYearsData[currentYear] = data;
                    document.body.className = data.theme || 'bamboo';
                }
            } catch (e) { initDataStructure(currentYear); }
        }

        function saveData() {
            fetch(`/api/plan/${currentYear}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(allYearsData[currentYear])
            }).catch(e => console.error('å„²å­˜å¤±æ•—', e));
        }

        function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            GRID_CONFIG.forEach(config => {
                const item = document.createElement('div');
                item.className = `grid-item ${config.isCenter ? 'center' : ''}`;
                if (config.isCenter) renderCenterCell(item, config);
                else renderNormalCell(item, config);
                container.appendChild(item);
            });
        }

        function renderCenterCell(item, config) {
            const data = allYearsData[currentYear].yearData[config.id];
            item.innerHTML = `<div class="grid-title">${config.title}</div>
                <input type="text" class="core-word-display" value="${data.coreWord||''}" oninput="updateCoreWord(this.value)" placeholder="æ ¸å¿ƒè©">`;
        }

        function updateCoreWord(val) {
            allYearsData[currentYear].yearData['core'].coreWord = val; saveData();
        }

        function renderNormalCell(item, config) {
            const isYear = currentMode === 'year';
            const data = isYear ? allYearsData[currentYear].yearData[config.id] : allYearsData[currentYear].monthData[currentMonth][config.id];
            const bgImages = allYearsData[currentYear].backgroundImages;
            const imgSrc = isYear ? bgImages.year[config.id] : (bgImages.month[currentMonth][config.id] || bgImages.year[config.id]);

            const goalsHtml = data.goals.map((g, idx) => {
                // ç”¢ç”Ÿé—œè¯è³‡è¨Šæ–‡å­—
                let linkText = '';
                if (!isYear && g.yearGoalId) {
                    const yearGoals = allYearsData[currentYear].yearData[config.id].goals;
                    const linkedGoal = yearGoals.find(yg => yg.id === g.yearGoalId);
                    if (linkedGoal) linkText = `<div class="linked-goal-info">â†³ é—œè¯ï¼š${linkedGoal.text}</div>`;
                }

                // ç”¢ç”Ÿé’è›™åœ–ç¤º
                const frogIcon = g.hasFrog ? '<span class="goal-frog-icon">ğŸ¸</span>' : '';

                return `
                <li class="goal-item">
                    <div class="goal-header">
                        <div class="goal-number">${idx+1}</div>
                        <div class="goal-checkbox ${g.completed?'checked':''}" onclick="toggleGoal('${config.id}', ${idx})"></div>
                        <div class="goal-text-wrapper">
                            <div class="goal-text" contenteditable="true" onblur="updateGoal('${config.id}', ${idx}, this.innerText)">${frogIcon}${g.text}</div>
                            ${linkText}
                        </div>
                        <div class="action-btns">
                            <button class="mini-btn btn-frog ${g.hasFrog?'active':''}" onclick="toggleFrog('${config.id}', ${idx})" title="æ¨™è¨˜é‡é»">ğŸ¸</button>
                            ${!isYear ? `<button class="mini-btn" onclick="openLinkModal('${config.id}', ${idx})" title="é—œè¯å¹´åº¦ç›®æ¨™">ğŸ”—</button>` : ''}
                            <button class="mini-btn" onclick="deleteGoal('${config.id}', ${idx})">Ã—</button>
                        </div>
                    </div>
                </li>`;
            }).join('');

            item.innerHTML = `
                <div class="grid-title">${config.title}</div>
                <ul class="goals-list">${goalsHtml}</ul>
                <div class="grid-footer">
                    <div class="add-input-wrapper">
                        <input type="text" class="add-input" placeholder="æ–°å¢ç›®æ¨™..." onkeypress="if(event.key==='Enter') addGoal('${config.id}', this)">
                        <button class="add-btn" onclick="addGoal('${config.id}', this.previousElementSibling)">+</button>
                    </div>
                    <div class="image-display-area" onclick="triggerFileUpload('${config.id}')">
                        ${imgSrc ? `<img src="${imgSrc}">` : `<span class="image-placeholder">é»æ“Šä¸Šå‚³åœ–ç‰‡</span>`}
                        <div class="img-controls">
                            <button class="mini-btn" style="background:#2196f3;color:white" onclick="event.stopPropagation();triggerFileUpload('${config.id}')">æ›´æ›</button>
                            ${imgSrc ? `<button class="mini-btn" style="background:#f44336;color:white" onclick="event.stopPropagation();removeImage('${config.id}')">åˆªé™¤</button>` : ''}
                        </div>
                    </div>
                    <input type="file" id="file-${config.id}" style="display:none" accept="image/*" onchange="uploadImage('${config.id}', this)">
                </div>`;
        }

        // --- é‚è¼¯åŠŸèƒ½ ---
        function addGoal(gridId, input) {
            if(!input.value.trim()) return;
            const isYear = currentMode === 'year';
            const targetData = isYear ? allYearsData[currentYear].yearData[gridId] : allYearsData[currentYear].monthData[currentMonth][gridId];
            
            // ç”¢ç”Ÿå”¯ä¸€ ID ä»¥ä¾›é—œè¯ä½¿ç”¨
            const newId = Date.now().toString(36) + Math.random().toString(36).substr(2);
            targetData.goals.push({ id: newId, text: input.value, completed: false, hasFrog: false, yearGoalId: null });
            
            input.value = '';
            saveData(); renderGrid();
        }

        function toggleGoal(gridId, idx) {
            const isYear = currentMode === 'year';
            const targetData = isYear ? allYearsData[currentYear].yearData[gridId] : allYearsData[currentYear].monthData[currentMonth][gridId];
            targetData.goals[idx].completed = !targetData.goals[idx].completed;
            saveData(); renderGrid();
        }

        function updateGoal(gridId, idx, text) {
            const isYear = currentMode === 'year';
            const targetData = isYear ? allYearsData[currentYear].yearData[gridId] : allYearsData[currentYear].monthData[currentMonth][gridId];
            targetData.goals[idx].text = text;
            saveData();
        }

        function deleteGoal(gridId, idx) {
            if(!confirm('ç¢ºå®šåˆªé™¤?')) return;
            const isYear = currentMode === 'year';
            const targetData = isYear ? allYearsData[currentYear].yearData[gridId] : allYearsData[currentYear].monthData[currentMonth][gridId];
            targetData.goals.splice(idx, 1);
            saveData(); renderGrid();
        }

        // é’è›™åŠŸèƒ½
        function toggleFrog(gridId, idx) {
            const isYear = currentMode === 'year';
            const targetData = isYear ? allYearsData[currentYear].yearData[gridId] : allYearsData[currentYear].monthData[currentMonth][gridId];
            targetData.goals[idx].hasFrog = !targetData.goals[idx].hasFrog;
            saveData(); renderGrid();
        }

        // é—œè¯åŠŸèƒ½
        function openLinkModal(gridId, idx) {
            pendingLink = { gridId, idx };
            const modal = document.getElementById('linkModal');
            const list = document.getElementById('linkOptionsList');
            const yearGoals = allYearsData[currentYear].yearData[gridId].goals;
            
            let html = `<div class="link-option" onclick="setLink(null)">[ç„¡é—œè¯]</div>`;
            yearGoals.forEach(g => {
                html += `<div class="link-option" onclick="setLink('${g.id}')">${g.text}</div>`;
            });
            list.innerHTML = html;
            modal.style.display = 'flex';
        }

        function setLink(yearGoalId) {
            if (pendingLink) {
                const { gridId, idx } = pendingLink;
                allYearsData[currentYear].monthData[currentMonth][gridId].goals[idx].yearGoalId = yearGoalId;
                saveData(); renderGrid();
            }
            document.getElementById('linkModal').style.display = 'none';
            pendingLink = null;
        }

        function closeModal(e) {
            if (e.target.id === 'linkModal') {
                document.getElementById('linkModal').style.display = 'none';
            }
        }

        // åœ–ç‰‡ä¸Šå‚³ (ç¶­æŒåŸé‚è¼¯)
        function triggerFileUpload(gridId) { document.getElementById(`file-${gridId}`).click(); }
        
        async function uploadImage(gridId, input) {
            const file = input.files[0];
            if (!file) return;
            try {
                const resizedImage = await compressImage(file);
                const bgImages = allYearsData[currentYear].backgroundImages;
                if (currentMode === 'year') bgImages.year[gridId] = resizedImage;
                else bgImages.month[currentMonth][gridId] = resizedImage;
                saveData(); renderGrid();
            } catch (error) { alert("ä¸Šå‚³å¤±æ•—"); }
            finally { input.value = ''; }
        }

        function removeImage(gridId) {
            const bgImages = allYearsData[currentYear].backgroundImages;
            if(currentMode === 'year') delete bgImages.year[gridId];
            else delete bgImages.month[currentMonth][gridId];
            saveData(); renderGrid();
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 800; 
                        let w = img.width; let h = img.height;
                        if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function switchMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.mode-btn[data-mode="${mode}"]`).classList.add('active');
            document.getElementById('monthSelector').style.display = mode === 'month' ? 'flex' : 'none';
            renderGrid();
        }

        function switchPage(page) {
            document.getElementById('plannerPage').style.display = page === 'planner' ? 'block' : 'none';
            document.getElementById('statsPage').style.display = page === 'stats' ? 'block' : 'none';
            if(page === 'stats') updateStats();
        }

        function updateStats() {
            let total = 0, done = 0;
            Object.values(allYearsData[currentYear].yearData).forEach(g => {
                if(g.goals) {
                    total += g.goals.length;
                    done += g.goals.filter(x => x.completed).length;
                }
            });
            const percent = total === 0 ? 0 : Math.round((done/total)*100);
            document.getElementById('statsContent').innerHTML = `<div style="font-size:3rem; color:var(--accent); font-weight:bold;">${percent}%</div><div>å¹´åº¦ç›®æ¨™ï¼šå®Œæˆ ${done} / ${total}</div>`;
        }

        // è³‡æ–™åº«æ“ä½œ
        async function handleBackup() { window.location.href = '/api/db/backup'; }
        async function handleRestore(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    await fetch('/api/db/restore', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(json) });
                    window.location.reload();
                } catch (err) { alert('é‚„åŸå¤±æ•—'); }
            };
            reader.readAsText(file);
        }
        async function handleClearData() {
            if(!confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿ')) return;
            await fetch('/api/test/clear-data', { method: 'DELETE' });
            window.location.reload();
        }

        initApp();
    </script>
</body>
</html>
